<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік відключень електроенергії</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
    .error { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1 id="title">Завантаження...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
// Кольори для графіку
const COLOR_POWER_ON  = "#FFD700";  // світло є (жовтий)
const COLOR_POWER_OFF = "#000000";  // світла немає (чорний)

// Перетворення часу "ГГ:ХХ" у хвилини від початку доби (0..1440)
function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

// Головна функція
async function loadPowerData() {
    try {
        // 1. Завантажуємо JSON файл, створений GitHub Action
        // Додаємо ?v=timestamp, щоб браузер завжди брав свіжу версію, а не з пам'яті
        const response = await fetch('./power_data.json?v=' + new Date().getTime());
        
        if (!response.ok) {
            throw new Error(`Не вдалося знайти файл даних (Status ${response.status})`);
        }

        const json = await response.json();

        // 2. Оновлюємо заголовки на сторінці
        document.getElementById("title").textContent = `Графік погодинних відключень на ${json.target_date}`;
        
        // Показуємо час оновлення (або з сайту обленерго, або час сканування)
        const updateTime = json.updated_at_site || new Date(json.scan_date).toLocaleString('uk-UA');
        document.getElementById("updated").textContent = `Інформація станом на: ${updateTime}`;

        // 3. Підготовка даних для графіку
        const schedule = json.data; // Об'єкт типу { "1.1": ["12:00-14:00"], "1.2": ... }
        
        // Сортуємо групи, щоб йшли по порядку (1.1, 1.2, 2.1 ...)
        const groups = Object.keys(schedule).sort(); 
        const traces = [];

        // Проходимось по кожній групі
        groups.forEach(group => {
            let last = 0;
            // Отримуємо масив інтервалів відключень, наприклад ["12:00-14:00", "18:00-20:00"]
            const intervalsStr = schedule[group] || []; 
            
            // Перетворюємо їх на цифри
            const outages = intervalsStr.map(interval => {
                const [start, end] = interval.split("-").map(s => s.trim());
                return [toMinutes(start), toMinutes(end)];
            });

            // Малюємо лінію часу
            outages.forEach(([start, end]) => {
                // Якщо є проміжок між останнім відключенням і новим -> малюємо ЖОВТЕ (світло є)
                if (start > last) {
                    traces.push({
                        x: [last, start],
                        y: [group, group],
                        mode: "lines",
                        line: { width: 18, color: COLOR_POWER_ON },
                        hoverinfo: "text",
                        text: `${group}: Електроенергія є (${formatTime(last)} - ${formatTime(start)})`,
                        showlegend: false
                    });
                }

                // Малюємо ЧОРНЕ (світла немає)
                traces.push({
                    x: [start, end],
                    y: [group, group],
                    mode: "lines",
                    line: { width: 18, color: COLOR_POWER_OFF },
                    hoverinfo: "text",
                    text: `${group}: Відключення ${formatTime(start)} – ${formatTime(end)}`,
                    showlegend: false
                });

                last = end;
            });

            // Домальовуємо жовте до кінця доби (якщо останнє відключення було раніше 24:00)
            if (last < 1440) {
                traces.push({
                    x: [last, 1440],
                    y: [group, group],
                    mode: "lines",
                    line: { width: 18, color: COLOR_POWER_ON },
                    hoverinfo: "text",
                    text: `${group}: Електроенергія є (${formatTime(last)} - 24:00)`,
                    showlegend: false
                });
            }
        });

        // 4. Налаштування відображення (Layout)
        const layout = {
            showlegend: false,
            xaxis: {
                title: "Час доби",
                range: [0, 1440],
                tickvals: Array.from({ length: 25 }, (_, i) => i * 60), // Поділки щогодини
                ticktext: Array.from({ length: 25 }, (_, i) => `${i}:00`),
                fixedrange: true // заборонити зум по горизонталі (опціонально)
            },
            yaxis: {
                title: "Групи",
                type: "category",
                categoryorder: "array",
                categoryarray: groups.reverse() // Щоб 1.1 була зверху, а не знизу
            },
            hovermode: 'closest',
            // Червона лінія поточного часу
            shapes: [{
                type: "line",
                x0: getCurrentMinutes(),
                x1: getCurrentMinutes(),
                y0: -1,
                y1: groups.length,
                line: { color: "red", width: 2, dash: "dash" }
            }]
        };

        Plotly.newPlot("chart", traces, layout, {responsive: true});

        // Запускаємо оновлення червоної лінії щохвилини
        startClockUpdate();

    } catch (error) {
        console.error(error);
        document.getElementById("updated").innerHTML = `<span class="error">Помилка завантаження даних: ${error.message}</span>`;
    }
}

// Допоміжна: хвилини -> текст "14:30"
function formatTime(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function getCurrentMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function startClockUpdate() {
    setInterval(() => {
        const current = getCurrentMinutes();
        const clamped = Math.min(current, 1440);
        Plotly.relayout("chart", {
            "shapes[0].x0": clamped,
            "shapes[0].x1": clamped
        });
    }, 60000);
}

// Запуск
loadPowerData();

</script>
</body>
</html>
