<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Графік відключень</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #fafafa;
        }
        h2 {
            margin-bottom: 5px;
        }
        #updated {
            color: #555;
            margin-bottom: 20px;
        }
        canvas {
            width: 100%;
            height: 400px;
        }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h2 id="title">Завантаження...</h2>
<div id="updated"></div>
<canvas id="chart"></canvas>

<script>
    // CSV URLs
    const CSV_INFO = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=0";
    const CSV_DATA = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=1945313917";

    // Завантаження CSV з коректною підтримкою UTF-8
    async function fetchCSV(url) {
        const response = await fetch(url);
        const buffer = await response.arrayBuffer();
        return new TextDecoder("utf-8").decode(buffer);
    }

    // Парсер CSV
    function parseCSV(text) {
        return text.trim().split("\n").map(row =>
            row.split(",").map(cell => cell.replace(/^"|"$/g, "").trim())
        );
    }

    async function loadInfo() {
        const csv = await fetchCSV(CSV_INFO);
        const rows = parseCSV(csv);

        // Структура A1:
        // A1: Графік погодинних відключень на <дата>
        // A2: Інформація станом на <дата час>
        document.getElementById("title").textContent = rows[0][0];
        document.getElementById("updated").textContent = rows[1][0];
    }

    async function loadChart() {
        const csv = await fetchCSV(CSV_DATA);
        const rows = parseCSV(csv);

        const labels = rows[0].slice(1); // часи 00:00–23:00
        const datasets = [];

        for (let i = 1; i < rows.length; i++) {
            const group = rows[i][0];
            const values = rows[i].slice(1).map(v => v === "1" ? 1 : 0);

            datasets.push({
                label: group,
                data: values,
                borderWidth: 2,
                fill: false
            });
        }

        const ctx = document.getElementById("chart").getContext("2d");

        new Chart(ctx, {
            type: "line",
            data: { labels, datasets },
            options: {
                responsive: true,
                scales: {
                    y: {
                        ticks: {
                            callback: val => val === 1 ? "Вимкн." : ""
                        },
                        min: 0,
                        max: 1
                    }
                }
            }
        });
    }

    async function init() {
        await loadInfo();
        await loadChart();
    }

    init();
</script>
</body>
</html>
