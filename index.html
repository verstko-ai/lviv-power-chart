<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
</style>
</head>
<body>

<h1 id="title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
const CSV_INFO = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=0";
const CSV_DATA = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=1945313917";

const COLOR_POWER_ON  = "#FFD700"; // –∂–æ–≤—Ç–∏–π
const COLOR_POWER_OFF = "#000000"; // —á–æ—Ä–Ω–∏–π

function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

async function fetchCSV(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer();
    return new TextDecoder("utf-8").decode(buffer);
}

function parseCSV(text) {
    return text
        .trim()
        .split("\n")
        .map(row =>
            row
                .split(",")
                .map(cell => cell.replace(/^"|"$/g, "").trim())
        );
}

async function loadInfo() {
    const csv = await fetchCSV(CSV_INFO);
    const rows = parseCSV(csv);
    document.getElementById("title").textContent   = `–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–∞ ${rows[0][1]}`;
    document.getElementById("updated").textContent = `–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å—Ç–∞–Ω–æ–º –Ω–∞ ${rows[1][1]}`;
}

async function loadChart() {
    const csv = await fetchCSV(CSV_DATA);
    const rows = parseCSV(csv);

    const groups  = [];
    const outages = {};

    // –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–ê –ª–æ–≥—ñ–∫–∞: –±–µ—Ä–µ–º–æ —Ä—è–¥–æ–∫ –∑ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –∑ –¥—Ä—É–≥–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è —ñ —Ä—ñ–∂–µ–º–æ –ø–æ –∫–æ–º–∞—Ö
    for (let i = 0; i < rows.length; i++) {
        const group = rows[i][0];
        groups.push(group);

        const intervalsStr = rows[i][1] || "";
        const intervals = intervalsStr
            .split(",")
            .map(s => s.trim())
            .filter(s => s.length > 0);

        outages[group] = intervals.map(interval => {
            const [start, end] = interval.split("-").map(s => s.trim());
            return [start, end];  // ["HH:MM", "HH:MM"]
        });
    }

    // üîπ –†–û–ó–†–ê–•–£–ù–û–ö –ü–†–ê–í–û–á –ú–ï–ñ–Ü –î–õ–Ø –û–°–Ü X (maxX)
    const STEP = 5; // 5 —Ö–≤–∏–ª–∏–Ω
    let globalMaxEnd = 0;

    groups.forEach(group => {
        outages[group].forEach(([startStr, endStr]) => {
            const end = toMinutes(endStr);
            if (end > globalMaxEnd) globalMaxEnd = end;
        });
    });

    // —è–∫—â–æ —Ä–∞–ø—Ç–æ–º –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö ‚Äî –¥–æ–±–∞
    if (globalMaxEnd === 0) {
        globalMaxEnd = 1440;
    }

    let maxX = Math.ceil(globalMaxEnd / STEP) * STEP;
    if (maxX > 1440) maxX = 1440; // –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ –Ω–µ –≤–∏—Ö–æ–¥–∏–º–æ –∑–∞ –¥–æ–±—É

    const traces = [];

    // üîπ –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–ê –ø–æ–±—É–¥–æ–≤–∞ —Ç—Ä–µ–π—Å—ñ–≤ (–Ω—ñ—á–æ–≥–æ –Ω–µ —á—ñ–ø–∞—î–º–æ, –∫—Ä—ñ–º –¥–æ–¥–∞–Ω–æ—ó opacity –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ)
    groups.forEach(group => {
        let last = 0;
        const intervals = outages[group];

        intervals.forEach(interval => {
            const start = toMinutes(interval[0]);
            const end   = toMinutes(interval[1]);

            if (start > last) {
                traces.push({
                    x: [last, start],
                    y: [group, group],
                    mode: "lines",
                    line: { width: 18, color: COLOR_POWER_ON },
                    hoverinfo: "text",
                    text: `${group}: –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è —î`,
                    showlegend: false,
                    opacity: 1
                });
            }

            traces.push({
                x: [start, end],
                y: [group, group],
                mode: "lines",
                line: { width: 18, color: COLOR_POWER_OFF },
                hoverinfo: "text",
                text: `${group}: –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ${interval[0]}‚Äì${interval[1]}`,
                showlegend: false,
                opacity: 1
            });

            last = end;
        });

        // "—Ö–≤—ñ—Å—Ç" –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏ (—è–∫ –±—É–ª–æ): 1440
        if (last < 1440) {
            traces.push({
                x: [last, 1440],
                y: [group, group],
                mode: "lines",
                line: { width: 18, color: COLOR_POWER_ON },
                hoverinfo: "text",
                text: `${group}: –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è —î`,
                showlegend: false,
                opacity: 1
            });
        }
    });

    function getCurrentMinutes() {
        const now = new Date();
        return now.getHours() * 60 + now.getMinutes();
    }

    // üîπ –û–°–¨ X —Ç–∞ —á–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è "–∑–∞—Ä–∞–∑" –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω—ñ –¥–æ maxX
    const maxHour  = Math.ceil(maxX / 60);
    const tickvals = Array.from({ length: maxHour + 1 }, (_, i) => i * 60);
    const ticktext = Array.from({ length: maxHour + 1 }, (_, i) =>
        `${i.toString().padStart(2,"0")}:00`
    );

    const currentInitial = Math.min(getCurrentMinutes(), maxX);

    const layout = {
        showlegend: false,
        xaxis: {
            title: "–ß–∞—Å",
            range: [0, maxX],     // üëà —Ç—É—Ç —Å—Ç–∏—Å–∫–∞—î–º–æ –¥—ñ–∞–ø–∞–∑–æ–Ω
            tickvals: tickvals,
            ticktext: ticktext
        },
        yaxis: {
            title: "–ì—Ä—É–ø–∏",
            type: "category",
            categoryorder: "array",
            categoryarray: groups
        },
        shapes: [{
            type: "line",
            x0: currentInitial,
            x1: currentInitial,
            y0: -1,
            y1: groups.length,
            line: { color: "red", width: 2, dash: "dash" }
        }]
    };

    Plotly.newPlot("chart", traces, layout);

    // üîπ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó —Ä–∞–∑ –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É, –∞–ª–µ –≤ –º–µ–∂–∞—Ö maxX
    setInterval(() => {
        const current = Math.min(getCurrentMinutes(), maxX);
        Plotly.relayout("chart", {
            "shapes[0].x0": current,
            "shapes[0].x1": current
        });
    }, 60000);
}

async function init() {
    await loadInfo();
    await loadChart();
}

init();
</script>
</body>
</html>
