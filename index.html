<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік відключень електроенергії</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
</style>
</head>
<body>

<h1 id="title">Завантаження...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
const CSV_INFO = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=0";
const CSV_DATA = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=1945313917";

const COLOR_POWER_ON = "#FFD700"; // жовтий
const COLOR_POWER_OFF = "#000000"; // чорний

// Функція для конвертації часу в хвилини (0-1440)
function toMinutes(t) {
    if (t === "24:00") { 
        return 1440; 
    }
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

// Допоміжна функція для перетворення хвилин у рядок часу HH:MM
function minutesToTimeStr(minutes) {
    if (minutes === 1440) return "24:00";
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    const hourStr = String(h).padStart(2, '0');
    const minuteStr = String(m).padStart(2, '0');
    return `${hourStr}:${minuteStr}`;
}

async function fetchCSV(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer();
    return new TextDecoder("utf-8").decode(buffer);
}

// *** ВИДАЛЕНО: Стандартний parseCSV, замінено на прямий парсинг у loadChart ***
function parseCSV(text) {
    return text.trim().split("\n"); // Просто розділяємо на рядки
}

async function loadInfo() {
    const csv = await fetchCSV(CSV_INFO);
    const rows = parseCSV(csv);
    // Припускаємо, що метадані завжди йдуть у перших двох рядках
    const infoRow = rows[0].split(",").map(cell => cell.replace(/^"|"$/g,'').trim());
    const updatedRow = rows[1].split(",").map(cell => cell.replace(/^"|"$/g,'').trim());
    
    document.getElementById("title").textContent = `Графік погодинних відключень на ${infoRow[1]}`;
    document.getElementById("updated").textContent = `Інформація станом на ${updatedRow[1]}`;
}

async function loadChart() {
    const csv = await fetchCSV(CSV_DATA);
    const rows = parseCSV(csv); // Отримуємо масив рядків

    const groups = [];
    const outages = {};
    
    // Ітерація по всіх рядках даних
    rows.forEach(row => {
        // *** КЛЮЧОВЕ ВИПРАВЛЕННЯ: Надійний парсинг двох колонок ***
        // Використовуємо регулярний вираз для розділення: 
        // 1. Назва групи (будь-що до першої коми)
        // 2. Інтервали (будь-що після першої коми, видаляючи зовнішні лапки)
        
        const match = row.match(/^([^,]+),?(.+)$/); // Шукаємо "Група,"Інтервали"
        if (!match) return; 

        let group = match[1].trim(); // Назва групи
        let intervalsStr = match[2].replace(/^"|"$/g, '').trim(); // Рядок інтервалів, очищений від лапок
        
        // Фільтруємо заголовки та пусті дані
        if (!group || !intervalsStr || group === "Група" || group === "Group") return; 

        groups.push(group);
        
        // Розбиваємо рядок з інтервалами на окремі елементи, видаляючи пробіли
        const cleanIntervalsStr = intervalsStr.replace(/\s/g, ''); 
        const intervals = cleanIntervalsStr.split(",").filter(s => s.includes('-')); 
        
        // *** ДІАГНОСТИКА: Перевірте консоль браузера! ***
        if (group === "1.1") {
            console.log(`Група ${group} знайдено інтервалів: ${intervals.length}. Дані:`, intervals);
        }
        
        outages[group] = intervals.map(interval=>{
            let [start,end] = interval.split("-").map(s=>s.trim()); 
            
            if (end === "00:00") end = "24:00"; 
            
            return [start,end]; 
        });
    });
    
    // Якщо не знайдено жодної групи, можливо, є проблема з заголовками
    if (groups.length === 0) {
        console.error("Не знайдено жодної групи даних. Перевірте формат CSV.");
    }

    const traces = [];

    groups.forEach(group=>{
        let last = 0; // Хвилини (починаємо з 00:00)
        const intervals = outages[group];

        // ЦИКЛ ОБРОБКИ ІНТЕРВАЛІВ
        intervals.forEach(interval=>{
            const startStr = interval[0];
            const endStr = interval[1];
            
            const start = toMinutes(startStr); // Хвилини
            const end = toMinutes(endStr);   // Хвилини
            
            if (start >= end && end !== 1440) return;

            // 1. Світло є (від last до start)
            if(start > last){
                traces.push({
                    x:[last,start],
                    y:[group,group],
                    mode:"lines",
                    line:{width:18,color:COLOR_POWER_ON},
                    hoverinfo:"text",
                    text:`${group}: Електроенергія є ${last === 0 ? "00:00" : minutesToTimeStr(last)}–${startStr}`,
                    showlegend:false
                });
            }

            // 2. Відключення (від start до end)
            traces.push({
                x:[start,end],
                y:[group,group],
                mode:"lines",
                line:{width:18,color:COLOR_POWER_OFF},
                hoverinfo:"text",
                text:`${group}: Відключення ${startStr}–${endStr === "24:00" ? "00:00" : endStr}`,
                showlegend:false
            });

            last = end; 
        });

        // 3. Світло є до кінця дня (від last до 1440)
        if(last < 1440){
            traces.push({
                x:[last,1440],
                y:[group,group],
                mode:"lines",
                line:{width:18,color:COLOR_POWER_ON},
                hoverinfo:"text",
                text:`${group}: Електроенергія є ${minutesToTimeStr(last)}–24:00`,
                showlegend:false
            });
        }
    });

    function getCurrentMinutes(){
        const now=new Date();
        return now.getHours()*60 + now.getMinutes() + (now.getSeconds() / 60); 
    }
    
    // Створення 25 міток для 24-годинного графіка
    const tickVals = Array.from({length: 25}, (_, i) => i * 60); 
    
    const tickText = Array.from({length: 25}, (_, i) => {
        const hour = i;
        if (hour === 24) return "24:00";
        return `${String(hour).padStart(2, '0')}:00`;
    });


    const layout = {
        showlegend:false,
        xaxis:{
            title:"Час",
            type: "linear", 
            range:[0,1440], 
            tickvals: tickVals, 
            ticktext: tickText, 
            tickangle: 0 
        },
        yaxis:{
            title:"Групи",
            type: "category",
            categoryorder: "array",
            categoryarray: groups
        },
        shapes:[{
            type:"line",
            x0:getCurrentMinutes(),
            x1:getCurrentMinutes(),
            y0:-1,
            y1:groups.length,
            line:{color:"red",width:2,dash:"dash"}
        }]
    };

    Plotly.newPlot("chart",traces,layout);

    // Оновлення лінії поточного часу
    setInterval(()=>{
        const current=getCurrentMinutes();
        Plotly.relayout("chart",{"shapes[0].x0":current,"shapes[0].x1":current});
    },10000); 
}

async function init(){
    await loadInfo();
    await loadChart();
}

init();
</script>
</body>
</html>
