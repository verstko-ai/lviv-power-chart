<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік відключень електроенергії</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
</style>
</head>
<body>

<h1 id="title">Завантаження...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
const CSV_INFO = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=0";
const CSV_DATA = "https://docs.google.com/spreadsheets/d/11sNa680oNGIDLCpeUJqkWd0gpxVIFz9gaZuop-hLE_8/export?format=csv&gid=1945313917";

const COLOR_POWER_ON  = "#FFD700";
const COLOR_POWER_OFF = "#000000";

// HH:MM -> minutes
function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

async function fetchCSV(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer();
    return new TextDecoder("utf-8").decode(buffer);
}

function parseCSV(text) {
    return text
        .trim()
        .split("\n")
        .map(row =>
            row
                .split(",")
                .map(cell => cell.replace(/^"|"$/g, "").trim())
        );
}

async function loadInfo() {
    const csv = await fetchCSV(CSV_INFO);
    const rows = parseCSV(csv);
    document.getElementById("title").textContent   = `Графік погодинних відключень на ${rows[0][1]}`;
    document.getElementById("updated").textContent = `Інформація станом на ${rows[1][1]}`;
}

async function loadChart() {
    const csv = await fetchCSV(CSV_DATA);
    const rows = parseCSV(csv);

    const groups = [];
    const outages = {};

    // КОЖЕН СТОВПЧИК ПІСЛЯ ПЕРШОГО = ОКРЕМИЙ ІНТЕРВАЛ
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const group = row[0];
        groups.push(group);

        outages[group] = row
            .slice(1)
            .map(v => v.trim())
            .filter(Boolean)
            .map(interval => {
                const [start, end] = interval.split("-").map(s => s.trim());
                return [start, end];
            });
    }

    // РАХУЄМО КІНЕЦЬ ОСІ Х
    const STEP = 5;

    let globalMaxEnd = 0;

    groups.forEach(group => {
        outages[group].forEach(([_, endStr]) => {
            const end = toMinutes(endStr);
            if (end > globalMaxEnd) globalMaxEnd = end;
        });
    });

    if (globalMaxEnd === 0) globalMaxEnd = 1440;

    const maxX = Math.ceil(globalMaxEnd / STEP) * STEP;

    const traces = [];

    // БУДУЄМО ГРАФІК
    groups.forEach(group => {
        let last = 0;

        outages[group].forEach(([startStr, endStr]) => {
            const start = toMinutes(startStr);
            const end = toMinutes(endStr);

            // світло
            if (start > last) {
                traces.push({
                    x:[last,start],
                    y:[group,group],
                    mode:"lines",
                    line:{width:18,color:COLOR_POWER_ON},
                    hoverinfo:"text",
                    text:`${group}: Електроенергія є`,
                    showlegend:false
                });
            }

            // відключення
            traces.push({
                x:[start,end],
                y:[group,group],
                mode:"lines",
                line:{width:18,color:COLOR_POWER_OFF},
                hoverinfo:"text",
                text:`${group}: Відключення ${startStr}–${endStr}`,
                showlegend:false
            });

            last = end;
        });

        // хвіст зі світлом
        if (last < maxX) {
            traces.push({
                x:[last,maxX],
                y:[group,group],
                mode:"lines",
                line:{width:18,color:COLOR_POWER_ON},
                hoverinfo:"text",
                text:`${group}: Електроенергія є`,
                showlegend:false
            });
        }
    });

    function getCurrentMinutes(){
        const now=new Date();
        return now.getHours()*60 + now.getMinutes();
    }

    // РОЗМІТКА ОСІ X
    const maxHour = Math.ceil(maxX/60);

    const tickvals = Array.from({length:maxHour+1},(_,i)=>i*60);
    const ticktext = Array.from({length:maxHour+1},(_,i)=>`${i.toString().padStart(2,"0")}:00`);

    const currentInitial = Math.min(getCurrentMinutes(), maxX);

    const layout = {
        showlegend:false,
        xaxis:{
            title:"Час",
            range:[0,maxX],
            tickvals: tickvals,
            ticktext: ticktext
        },
        yaxis:{
            title:"Групи",
            type: "category",
            categoryorder: "array",
            categoryarray: groups
        },
        shapes:[{
            type:"line",
            x0:currentInitial,
            x1:currentInitial,
            y0:-1,
            y1:groups.length,
            line:{color:"red",width:2,dash:"dash"}
        }]
    };

    Plotly.newPlot("chart", traces, layout);

    // РУХ ЧЕРВОНОЇ ЛІНІЇ
    setInterval(()=>{
        const current=Math.min(getCurrentMinutes(),maxX);
        Plotly.relayout("chart",{
            "shapes[0].x0":current,
            "shapes[0].x1":current
        });
    },60000);
}

async function init(){
    await loadInfo();
    await loadChart();
}

init();
</script>
</body>
</html>
