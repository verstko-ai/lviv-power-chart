<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік відключень електроенергії</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
    .error { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1 id="title">Завантаження...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
// Налаштування кольорів для груп (світло Є)
const GROUP_COLORS = {
    '1': '#FFA500', // Помаранчевий
    '2': '#32CD32', // Зелений
    '3': '#1E90FF', // Синій
    '4': '#9370DB', // Фіолетовий
    '5': '#FF69B4', // Рожевий
    '6': '#00CED1'  // Бірюзовий
};

const COLOR_POWER_OFF = "#000000"; // Чорний (світла немає)
const DEFAULT_COLOR   = "#FFD700"; // Жовтий (резерв)

// --- НАЛАШТУВАННЯ ТОВЩИНИ ---
const LINE_WIDTH = 45; // Було 18. Збільшили, щоб зменшити білі проміжки.

function getGroupColor(groupName) {
    const mainGroup = groupName.charAt(0); 
    return GROUP_COLORS[mainGroup] || DEFAULT_COLOR;
}

function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

async function loadPowerData() {
    try {
        const response = await fetch('./power_data.json?v=' + new Date().getTime());
        if (!response.ok) throw new Error(`Status ${response.status}`);
        const json = await response.json();

        document.getElementById("title").textContent = `Графік погодинних відключень на ${json.target_date}`;
        const updateTime = json.updated_at_site || new Date(json.scan_date).toLocaleString('uk-UA');
        document.getElementById("updated").textContent = `Інформація станом на: ${updateTime}`;

        const schedule = json.data;
        const groups = Object.keys(schedule).sort(); 
        const traces = [];

        groups.forEach(group => {
            let last = 0;
            const intervalsStr = schedule[group] || []; 
            const groupColor = getGroupColor(group);

            const outages = intervalsStr.map(interval => {
                const [start, end] = interval.split("-").map(s => s.trim());
                return [toMinutes(start), toMinutes(end)];
            });

            outages.forEach(([start, end]) => {
                // СВІТЛО Є
                if (start > last) {
                    traces.push({
                        x: [last, start],
                        y: [group, group],
                        mode: "lines",
                        line: { width: LINE_WIDTH, color: groupColor }, // Використовуємо нову ширину
                        hoverinfo: "text",
                        text: `${group}: Електроенергія є`,
                        showlegend: false,
                        xaxis: 'x'
                    });
                }

                // ВІДКЛЮЧЕННЯ
                traces.push({
                    x: [start, end],
                    y: [group, group],
                    mode: "lines",
                    line: { width: LINE_WIDTH, color: COLOR_POWER_OFF }, // Використовуємо нову ширину
                    hoverinfo: "text",
                    text: `${group}: Відключення ${formatTime(start)} – ${formatTime(end)}`,
                    showlegend: false,
                    xaxis: 'x'
                });

                last = end;
            });

            // Хвіст доби
            if (last < 1440) {
                traces.push({
                    x: [last, 1440],
                    y: [group, group],
                    mode: "lines",
                    line: { width: LINE_WIDTH, color: groupColor }, // Використовуємо нову ширину
                    hoverinfo: "text",
                    text: `${group}: Електроенергія є`,
                    showlegend: false,
                    xaxis: 'x'
                });
            }
        });

        const tickVals = Array.from({ length: 25 }, (_, i) => i * 60);
        const tickText = Array.from({ length: 25 }, (_, i) => `${i}:00`);

        const layout = {
            showlegend: false,
            // НИЖНЯ ВІСЬ
            xaxis: {
                title: "Час доби",
                range: [0, 1440],
                tickvals: tickVals,
                ticktext: tickText,
                side: 'bottom',
                fixedrange: true
            },
            // ВЕРХНЯ ВІСЬ
            xaxis2: {
                range: [0, 1440],
                tickvals: tickVals,
                ticktext: tickText,
                overlaying: 'x',
                side: 'top',
                matches: 'x',
                fixedrange: true
            },
            yaxis: {
                title: "Групи",
                type: "category",
                categoryorder: "array",
                categoryarray: groups.reverse()
            },
            hovermode: 'closest',
            shapes: [{
                type: "line",
                xref: "x", 
                x0: getCurrentMinutes(),
                x1: getCurrentMinutes(),
                y0: -0.5,
                y1: groups.length - 0.5,
                line: { color: "red", width: 2, dash: "dash" }
            }],
            margin: { t: 60, b: 60 } 
        };

        // Фіктивний графік для верхньої осі
        traces.push({
            x: [0, 1440],
            y: [groups[0], groups[0]],
            mode: 'markers',
            marker: { opacity: 0 },
            xaxis: 'x2',
            showlegend: false,
            hoverinfo: 'skip'
        });

        Plotly.newPlot("chart", traces, layout, {responsive: true});
        startClockUpdate();

    } catch (error) {
        console.error(error);
        document.getElementById("updated").innerHTML = `<span class="error">Помилка: ${error.message}</span>`;
    }
}

function formatTime(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function getCurrentMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function startClockUpdate() {
    setInterval(() => {
        const current = getCurrentMinutes();
        const clamped = Math.min(current, 1440);
        Plotly.relayout("chart", { "shapes[0].x0": clamped, "shapes[0].x1": clamped });
    }, 60000);
}

// Запуск + Автооновлення
loadPowerData();
setInterval(() => { console.log("Auto-refresh"); loadPowerData(); }, 900000);

</script>
</body>
</html>
