<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; font-size: 1.5rem; }
    #updated { margin-bottom: 15px; color: #666; font-size: 0.9rem; }
    #chart { width: 100%; height: 85vh; min-height: 500px; }
    .error { color: #d32f2f; font-weight: bold; padding: 20px; background: #ffebee; border-radius: 4px; }
    .info-mode { color: #0288d1; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
</style>
</head>
<body>

<h1 id="title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
// --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
const LINE_WIDTH = 45; 
const PALETTE = ['#FFA500', '#32CD32', '#1E90FF', '#9370DB', '#FF69B4', '#00CED1'];
const COLOR_POWER_OFF = "#333333"; 
const COLOR_MIDNIGHT = "#00008B"; // –ö–æ–ª—ñ—Ä —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á–∞ –¥–Ω—ñ–≤

// *** –ù–û–í–Ü –ö–û–ù–°–¢–ê–ù–¢–ò –î–õ–Ø –í–ï–†–•–ù–¨–û–á –®–ö–ê–õ–ò ***
const TOP_TIMELINE_GROUP_1 = "Top Timeline 1";
const TOP_TIMELINE_GROUP_2 = "Top Timeline 2";

// –®–∞–±–ª–æ–Ω –≥—Ä—É–ø
const DEFAULT_TEMPLATE = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];

function getGroupColor(groupName) {
    const match = groupName.match(/\d+/);
    if (match) {
        const num = parseInt(match[0]);
        return PALETTE[(num - 1) % PALETTE.length];
    }
    return PALETTE[0];
}

function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

// –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç–∏ –∑ —Ñ–æ—Ä–º–∞—Ç—É "DD.MM.YYYY" –≤ Date –æ–±'—î–∫—Ç
function parseDateKey(dateStr) {
    const parts = dateStr.split(".");
    // parts[2] = YYYY, parts[1] = MM, parts[0] = DD
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

async function loadPowerData() {
    try {
        const response = await fetch('./power_data.json?v=' + new Date().getTime());
        if (!response.ok) throw new Error(`Status ${response.status}`);
        const json = await response.json();

        // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
        const updateTime = json.updated_at_site || new Date(json.scan_date).toLocaleString('uk-UA');
        document.getElementById("updated").textContent = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${updateTime}`;

        // –û—Ç—Ä–∏–º—É—î–º–æ –∫–ª—é—á—ñ –¥–∞—Ç (—Å–æ—Ä—Ç—É—î–º–æ, —â–æ–± 09.12 –π—à–ª–æ –ø–µ—Ä–µ–¥ 10.12)
        let dateKeys = Object.keys(json.schedules || {}).sort((a, b) => parseDateKey(a) - parseDateKey(b));
        
        if (dateKeys.length === 0) throw new Error("–î–∞–Ω—ñ –ø–æ—Ä–æ–∂–Ω—ñ –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç.");

        // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
        const today = new Date();
        today.setHours(0,0,0,0);
        
        // --- –õ–û–ì–Ü–ö–ê –í–ò–ë–û–†–£ –†–ï–ñ–ò–ú–£ ---
        let traces = [];
        let layoutShapes = [];
        let finalGroups = new Set(DEFAULT_TEMPLATE);
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É –≤ –∫–ª—é—á–∞—Ö JSON
        const todayStr = dateKeys.find(k => parseDateKey(k).getTime() === today.getTime());
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∑–∞–≤—Ç—Ä–∞
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowStr = dateKeys.find(k => parseDateKey(k).getTime() === tomorrow.getTime());

        let isCombinedMode = (todayStr && tomorrowStr);
        let chartTitle = "";
        let globalXMax = 1440; // 24 –≥–æ–¥–∏–Ω–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        let globalXMin = 0;

        if (isCombinedMode) {
            // === –†–ï–ñ–ò–ú 30 –ì–û–î–ò–ù ===
            chartTitle = `–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${todayStr} —Ç–∞ ${tomorrowStr}`;
            document.getElementById("updated").innerHTML += `<div class="info-mode">üìÖ –†–µ–∂–∏–º "–í–µ—á—ñ—Ä": –ø–æ–∫–∞–∑—É—î–º–æ –∑–∞–ª–∏—à–æ–∫ —Å—å–æ–≥–æ–¥–Ω—ñ —Ç–∞ –≤–µ—Å—å –∑–∞–≤—Ç—Ä–∞—à–Ω—ñ–π –¥–µ–Ω—å</div>`;

            // 1. –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø –∑ –æ–±–æ—Ö –¥–Ω—ñ–≤
            Object.keys(json.schedules[todayStr]).forEach(g => finalGroups.add(g));
            Object.keys(json.schedules[tomorrowStr]).forEach(g => finalGroups.add(g));
            
            // 2. –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–æ—á–∫—É —Å—Ç–∞—Ä—Ç—É (–ó–∞—Ä–∞–∑ –º—ñ–Ω—É—Å 6 –≥–æ–¥–∏–Ω, –∞–ª–µ –Ω–µ –º–µ–Ω—à–µ 0)
            const nowHour = new Date().getHours();
            const startLookback = Math.max(0, nowHour - 6); 
            globalXMin = startLookback * 60; // –ü–æ—á–∞—Ç–æ–∫ –æ—Å—ñ X (—Ö–≤–∏–ª–∏–Ω–∏)
            globalXMax = 1440 + 1440; // 48 –≥–æ–¥–∏–Ω (–∫—ñ–Ω–µ—Ü—å –∑–∞–≤—Ç—Ä–∞—à–Ω—å–æ–≥–æ –¥–Ω—è)

            // 3. –û–±—Ä–æ–±–∫–∞ –°–¨–û–ì–û–î–ù–Ü (offset 0)
            processDayData(json.schedules[todayStr], 0, traces, finalGroups);

            // 4. –û–±—Ä–æ–±–∫–∞ –ó–ê–í–¢–†–ê (offset 1440 —Ö–≤–∏–ª–∏–Ω)
            processDayData(json.schedules[tomorrowStr], 1440, traces, finalGroups);

            // 5. –î–æ–¥–∞—î–º–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á –¥–Ω—ñ–≤ (–ü—ñ–≤–Ω—ñ—á)
            layoutShapes.push({
                type: 'line',
                x0: 1440, x1: 1440,
                y0: -0.5, y1: finalGroups.size + 1.5, // –ó–±—ñ–ª—å—à—É—î–º–æ –≤–∏—Å–æ—Ç—É –¥–ª—è 2-—Ö –Ω–æ–≤–∏—Ö –≥—Ä—É–ø
                line: { color: COLOR_MIDNIGHT, width: 3, dash: 'dot' }
            });

        } else {
            // === –°–¢–ê–ù–î–ê–†–¢–ù–ò–ô –†–ï–ñ–ò–ú ===
            const targetDate = todayStr || dateKeys[0];
            chartTitle = `–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ ${targetDate}`;
            
            Object.keys(json.schedules[targetDate]).forEach(g => finalGroups.add(g));
            processDayData(json.schedules[targetDate], 0, traces, finalGroups);
        }

        document.getElementById("title").innerText = chartTitle;

        // *** –î–û–î–ê–Ñ–ú–û –ì–†–£–ü–ò –î–õ–Ø –í–ï–†–•–ù–¨–û–á –®–ö–ê–õ–ò ***
        finalGroups.add(TOP_TIMELINE_GROUP_2);
        finalGroups.add(TOP_TIMELINE_GROUP_1);
        
        // –°–æ—Ä—Ç—É—î–º–æ –≥—Ä—É–ø–∏ (—â–æ–± –Ω–æ–≤—ñ –±—É–ª–∏ –∑–≤–µ—Ä—Ö—É)
        let sortedGroups = [...finalGroups];
        // –í–∏–Ω–æ—Å–∏–º–æ –≥—Ä—É–ø–∏ —à–∫–∞–ª–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –º–∞—Å–∏–≤—É, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –ø–æ—Ä—è–¥–æ–∫ 2 -> 1
        sortedGroups = sortedGroups.filter(g => g !== TOP_TIMELINE_GROUP_1 && g !== TOP_TIMELINE_GROUP_2)
                                   .sort();
        sortedGroups.unshift(TOP_TIMELINE_GROUP_1);
        sortedGroups.unshift(TOP_TIMELINE_GROUP_2);
        
        // *** –î–û–î–ê–Ñ–ú–û –ü–û–†–û–ñ–ù–Ü –¢–†–ê–°–£–í–ê–ù–ù–Ø –î–õ–Ø –í–ï–†–•–ù–¨–û–á –®–ö–ê–õ–ò ***
        // –¶—ñ —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è –±—É–¥—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è —è–∫ –≤–µ—Ä—Ö–Ω—è –≤—ñ—Å—å X
        traces.push(createTrace(TOP_TIMELINE_GROUP_1, globalXMin, globalXMax, 'rgba(0,0,0,0)', ""));
        traces.push(createTrace(TOP_TIMELINE_GROUP_2, globalXMin, globalXMax, 'rgba(0,0,0,0)', ""));


        // –ë—É–¥—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
        buildChart(traces, sortedGroups, globalXMin, globalXMax, layoutShapes, isCombinedMode);

    } catch (error) {
        console.error(error);
        document.getElementById("updated").innerHTML = `<span class="error">–ü–æ–º–∏–ª–∫–∞: ${error.message}</span>`;
    }
}

// –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–Ω—è –≤ —Å–º—É–∂–∫–∏
function processDayData(schedule, offset, traces, allGroups) {
    allGroups.forEach(group => {
        // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≥—Ä—É–ø–∏ –≤–µ—Ä—Ö–Ω—å–æ—ó —à–∫–∞–ª–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –≤–∂–µ –¥–æ–¥–∞–Ω—ñ –≤ loadPowerData
        if (group === TOP_TIMELINE_GROUP_1 || group === TOP_TIMELINE_GROUP_2) return; 

        const intervalsStr = schedule[group] || [];
        const groupColor = getGroupColor(group);
        
        let dayStart = 0 + offset;
        let dayEnd = 1440 + offset;

        if (intervalsStr.length > 0) {
            let last = dayStart;
            
            const outages = intervalsStr.map(interval => {
                const [s, e] = interval.split("-");
                return [toMinutes(s) + offset, toMinutes(e) + offset];
            });

            outages.forEach(([start, end]) => {
                if (start > last) {
                    // –°–≤—ñ—Ç–ª–æ –Ñ
                    traces.push(createTrace(group, last, start, groupColor, "–°–≤—ñ—Ç–ª–æ —î"));
                }
                // –°–≤—ñ—Ç–ª–∞ –ù–ï–ú–ê–Ñ
                const timeLabel = formatTime(start - offset) + " - " + formatTime(end - offset);
                traces.push(createTrace(group, start, end, COLOR_POWER_OFF, `–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø: ${timeLabel}`));
                last = end;
            });

            if (last < dayEnd) {
                traces.push(createTrace(group, last, dayEnd, groupColor, "–°–≤—ñ—Ç–ª–æ —î"));
            }
        } else {
            // –ù–µ–º–∞—î –≤–∏–º–∫–Ω–µ–Ω—å —Ü—ñ–ª–∏–π –¥–µ–Ω—å
            traces.push(createTrace(group, dayStart, dayEnd, groupColor, "–ë–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å"));
        }
    });
}

function createTrace(group, start, end, color, text) {
    return {
        x: [start, end],
        y: [group, group],
        mode: "lines",
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ LINE_WIDTH —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≥—Ä—É–ø –¥–∞–Ω–∏—Ö, –¥–ª—è —à–∫–∞–ª–∏ ‚Äî 0
        line: { width: (group === TOP_TIMELINE_GROUP_1 || group === TOP_TIMELINE_GROUP_2) ? 0.1 : LINE_WIDTH, color: color },
        hoverinfo: "text",
        text: `${group}: ${text}`,
        showlegend: false
    };
}

function buildChart(traces, groups, xMin, xMax, shapes, isCombined) {
    // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—ñ–¥–ø–∏—Å—ñ–≤ –æ—Å—ñ X
    const tickVals = [];
    const tickText = [];
    
    // –†–æ–±–∏–º–æ –∫—Ä–æ–∫–∏ –ø–æ –≥–æ–¥–∏–Ω—ñ
    for (let i = 0; i <= xMax; i += 60) {
        if (i < xMin) continue;
        
        tickVals.push(i);
        
        let hour = Math.floor(i / 60);
        let displayHour = hour % 24;
        let suffix = "";
        
        if (isCombined) {
            if (hour === 0) suffix = " (–°—å–æ–≥–æ–¥–Ω—ñ)";
            if (hour === 24) suffix = " (–ó–ê–í–¢–†–ê)";
        }
        
        tickText.push(`${displayHour.toString().padStart(2, '0')}:00${suffix}`);
    }

    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É –ª—ñ–Ω—ñ–π (—Å—ñ—Ç–∫–∏ —Ç–∞ –ø—ñ–≤–Ω–æ—á—ñ) –ø—ñ–¥ –∫-—Å—Ç—å –≥—Ä—É–ø (+2 –¥–ª—è –≤–µ—Ä—Ö–Ω—å–æ—ó —à–∫–∞–ª–∏)
    const totalGroups = groups.length;
    shapes.forEach(s => {
        s.y1 = totalGroups - 0.5;
    });
    
    // –ü–æ–ª–æ–∂–µ–Ω–Ω—è —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó
    const lineYMax = totalGroups - 0.5;
    
    // –î–æ–¥–∞—î–º–æ –ª—ñ–Ω—ñ—é "–ó–∞—Ä–∞–∑"
    shapes.push({
        type: "line",
        xref: "x",
        x0: getCurrentTotalMinutes(),
        x1: getCurrentTotalMinutes(),
        y0: -0.5,
        y1: lineYMax,
        line: { color: "red", width: 2, dash: "dash" }
    });
    
    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –º—ñ—Ç–∫–∏ –æ—Å—ñ Y: –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –º—ñ—Ç–∫–∏ –¥–ª—è –≤–µ—Ä—Ö–Ω—ñ—Ö –≥—Ä—É–ø, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—Ö –¥–ª—è —à–∫–∞–ª–∏
    const yTickText = [...groups].reverse().map(group => {
        if (group === TOP_TIMELINE_GROUP_1 || group === TOP_TIMELINE_GROUP_2) {
            return ''; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –Ω–∞–∑–≤—É –≥—Ä—É–ø–∏, –∞–ª–µ –∑–∞–ª–∏—à–∞—î–º–æ –º—ñ—Å—Ü–µ
        }
        return group;
    });

    const layout = {
        xaxis: {
            range: [xMin, xMax], 
            tickvals: tickVals,
            // –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø –ú–Ü–¢–û–ö –î–õ–Ø –í–ï–†–•–ù–¨–û–á –®–ö–ê–õ–ò (–≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ticktext_overlay: 'true' –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∞–±–ª–æ–Ω—É)
            ticktext: tickText.map((text, index) => {
                // –ú—ñ—Ç–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ç—ñ–ª—å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ–π –æ—Å—ñ X (–∑–Ω–∏–∑—É)
                return text;
            }),
            fixedrange: true,
            gridcolor: '#eee'
        },
        yaxis: {
            title: "–ì—Ä—É–ø–∏",
            type: "category",
            categoryorder: "array",
            categoryarray: [...groups].reverse(),
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞—à –º–∞—Å–∏–≤ –∑ –ø–æ—Ä–æ–∂–Ω—ñ–º–∏ —Ä—è–¥–∫–∞–º–∏ –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –º—ñ—Ç–æ–∫
            ticktext: yTickText, 
            fixedrange: true,
            showgrid: true,
            zeroline: false
        },
        // *** –î–û–î–ê–Ñ–ú–û –î–†–£–ì–£ –í–Ü–°–¨ X –ó–í–ï–†–•–£ ***
        xaxis2: {
            overlaying: 'x', // –ù–∞–∫–ª–∞–¥–∞—î–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É –≤—ñ—Å—å X
            side: 'top',     // –†–æ–∑–º—ñ—â—É—î–º–æ –∑–≤–µ—Ä—Ö—É
            range: [xMin, xMax],
            tickvals: tickVals,
            ticktext: tickText,
            fixedrange: true,
            showline: true,
            linecolor: '#444',
            linewidth: 1,
            showgrid: false,
            zeroline: false
        },
        margin: { t: 40, b: 40, l: 60, r: 20 },
        hovermode: 'closest',
        shapes: shapes,
        height: totalGroups * 50 + 100 // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ –≤–∏—Å–æ—Ç–∞ –≥—Ä–∞—Ñ—ñ–∫—É
    };
    
    // *** –ü–†–ò–ö–†–Ü–ü–õ–Æ–Ñ–ú–û –¢–†–ê–°–£–í–ê–ù–ù–Ø –í–ï–†–•–ù–¨–û–á –®–ö–ê–õ–ò –î–û X2 (–í–ï–†–•–ù–¨–û–á –û–°–Ü) ***
    traces.forEach(trace => {
        if (trace.y[0] === TOP_TIMELINE_GROUP_1 || trace.y[0] === TOP_TIMELINE_GROUP_2) {
            trace.xaxis = 'x2'; 
        }
    });

    Plotly.newPlot("chart", traces, layout, {responsive: true});
    
    // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–µ—Å—É–≤–∞–Ω–Ω—è —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó
    startClockUpdate();
}

function formatTime(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function getCurrentTotalMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function startClockUpdate() {
    if (window.clockInterval) clearInterval(window.clockInterval);
    
    window.clockInterval = setInterval(() => {
        const current = getCurrentTotalMinutes();
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó (–æ—Å—Ç–∞–Ω–Ω—ñ–π shape –≤ –º–∞—Å–∏–≤—ñ)
        Plotly.relayout("chart", {
            'shapes[0].x0': current,
            'shapes[0].x1': current,
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–∫–æ–∂ —Ñ—ñ–≥—É—Ä—É-—Ä–æ–∑–¥—ñ–ª—é–≤–∞—á –ü—ñ–≤–Ω–æ—á—ñ, —è–∫—â–æ –≤–æ–Ω–∞ —î
            'shapes[1].x0': current,
            'shapes[1].x1': current,
        });

    }, 60000); // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∞–∑ –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É
}

// –°—Ç–∞—Ä—Ç
loadPowerData();
setInterval(() => loadPowerData(), 900000); // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è JSON –∫–æ–∂–Ω—ñ 15 —Ö–≤

</script>
</body>
</html>
