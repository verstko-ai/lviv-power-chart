<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    #updated { margin-bottom: 20px; color: #555; }
    #chart { width: 100%; max-width: 1400px; height: 800px; }
    .error { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1 id="title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
<div id="updated"></div>
<div id="chart"></div>

<script>
// –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—É
const COLOR_POWER_ON  = "#FFD700";  // —Å–≤—ñ—Ç–ª–æ —î (–∂–æ–≤—Ç–∏–π)
const COLOR_POWER_OFF = "#000000";  // —Å–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î (—á–æ—Ä–Ω–∏–π)

// –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–∞—Å—É "–ì–ì:–•–•" —É —Ö–≤–∏–ª–∏–Ω–∏ –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏ (0..1440)
function toMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

// –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
async function loadPowerData() {
    try {
        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ JSON —Ñ–∞–π–ª, —Å—Ç–≤–æ—Ä–µ–Ω–∏–π GitHub Action
        // –î–æ–¥–∞—î–º–æ ?v=timestamp, —â–æ–± –±—Ä–∞—É–∑–µ—Ä –∑–∞–≤–∂–¥–∏ –±—Ä–∞–≤ —Å–≤—ñ–∂—É –≤–µ—Ä—Å—ñ—é, –∞ –Ω–µ –∑ –ø–∞–º'—è—Ç—ñ
        const response = await fetch('./power_data.json?v=' + new Date().getTime());
        
        if (!response.ok) {
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –¥–∞–Ω–∏—Ö (Status ${response.status})`);
        }

        const json = await response.json();

        // 2. –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
        document.getElementById("title").textContent = `–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–∞ ${json.target_date}`;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–∞–±–æ –∑ —Å–∞–π—Ç—É –æ–±–ª–µ–Ω–µ—Ä–≥–æ, –∞–±–æ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è)
        const updateTime = json.updated_at_site || new Date(json.scan_date).toLocaleString('uk-UA');
        document.getElementById("updated").textContent = `–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å—Ç–∞–Ω–æ–º –Ω–∞: ${updateTime}`;

        // 3. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—É
        const schedule = json.data; // –û–±'—î–∫—Ç —Ç–∏–ø—É { "1.1": ["12:00-14:00"], "1.2": ... }
        
        // –°–æ—Ä—Ç—É—î–º–æ –≥—Ä—É–ø–∏, —â–æ–± –π—à–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É (1.1, 1.2, 2.1 ...)
        const groups = Object.keys(schedule).sort(); 
        const traces = [];

        // –ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—å –ø–æ –∫–æ–∂–Ω—ñ–π –≥—Ä—É–ø—ñ
        groups.forEach(group => {
            let last = 0;
            // –û—Ç—Ä–∏–º—É—î–º–æ –º–∞—Å–∏–≤ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ ["12:00-14:00", "18:00-20:00"]
            const intervalsStr = schedule[group] || []; 
            
            // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —ó—Ö –Ω–∞ —Ü–∏—Ñ—Ä–∏
            const outages = intervalsStr.map(interval => {
                const [start, end] = interval.split("-").map(s => s.trim());
                return [toMinutes(start), toMinutes(end)];
            });

            // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é —á–∞—Å—É
            outages.forEach(([start, end]) => {
                // –Ø–∫—â–æ —î –ø—Ä–æ–º—ñ–∂–æ–∫ –º—ñ–∂ –æ—Å—Ç–∞–Ω–Ω—ñ–º –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º —ñ –Ω–æ–≤–∏–º -> –º–∞–ª—é—î–º–æ –ñ–û–í–¢–ï (—Å–≤—ñ—Ç–ª–æ —î)
                if (start > last) {
                    traces.push({
                        x: [last, start],
                        y: [group, group],
                        mode: "lines",
                        line: { width: 18, color: COLOR_POWER_ON },
                        hoverinfo: "text",
                        text: `${group}: –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è —î (${formatTime(last)} - ${formatTime(start)})`,
                        showlegend: false
                    });
                }

                // –ú–∞–ª—é—î–º–æ –ß–û–†–ù–ï (—Å–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î)
                traces.push({
                    x: [start, end],
                    y: [group, group],
                    mode: "lines",
                    line: { width: 18, color: COLOR_POWER_OFF },
                    hoverinfo: "text",
                    text: `${group}: –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ${formatTime(start)} ‚Äì ${formatTime(end)}`,
                    showlegend: false
                });

                last = end;
            });

            // –î–æ–º–∞–ª—å–æ–≤—É—î–º–æ –∂–æ–≤—Ç–µ –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏ (—è–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—î –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ 24:00)
            if (last < 1440) {
                traces.push({
                    x: [last, 1440],
                    y: [group, group],
                    mode: "lines",
                    line: { width: 18, color: COLOR_POWER_ON },
                    hoverinfo: "text",
                    text: `${group}: –ï–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—è —î (${formatTime(last)} - 24:00)`,
                    showlegend: false
                });
            }
        });

        // 4. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (Layout)
        const layout = {
            showlegend: false,
            xaxis: {
                title: "–ß–∞—Å –¥–æ–±–∏",
                range: [0, 1440],
                tickvals: Array.from({ length: 25 }, (_, i) => i * 60), // –ü–æ–¥—ñ–ª–∫–∏ —â–æ–≥–æ–¥–∏–Ω–∏
                ticktext: Array.from({ length: 25 }, (_, i) => `${i}:00`),
                fixedrange: true // –∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –∑—É–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
            },
            yaxis: {
                title: "–ì—Ä—É–ø–∏",
                type: "category",
                categoryorder: "array",
                categoryarray: groups.reverse() // –©–æ–± 1.1 –±—É–ª–∞ –∑–≤–µ—Ä—Ö—É, –∞ –Ω–µ –∑–Ω–∏–∑—É
            },
            hovermode: 'closest',
            // –ß–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Å—É
            shapes: [{
                type: "line",
                x0: getCurrentMinutes(),
                x1: getCurrentMinutes(),
                y0: -1,
                y1: groups.length,
                line: { color: "red", width: 2, dash: "dash" }
            }]
        };

        Plotly.newPlot("chart", traces, layout, {responsive: true});

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó —â–æ—Ö–≤–∏–ª–∏–Ω–∏
        startClockUpdate();

    } catch (error) {
        console.error(error);
        document.getElementById("updated").innerHTML = `<span class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ${error.message}</span>`;
    }
}

// –î–æ–ø–æ–º—ñ–∂–Ω–∞: —Ö–≤–∏–ª–∏–Ω–∏ -> —Ç–µ–∫—Å—Ç "14:30"
function formatTime(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function getCurrentMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function startClockUpdate() {
    setInterval(() => {
        const current = getCurrentMinutes();
        const clamped = Math.min(current, 1440);
        Plotly.relayout("chart", {
            "shapes[0].x0": clamped,
            "shapes[0].x1": clamped
        });
    }, 60000);
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ
loadPowerData();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ–∂–Ω—ñ 10 —Ö–≤–∏–ª–∏–Ω (600000 –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥)
setInterval(() => {
    console.log("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...");
    loadPowerData(); 
}, 600000);

</script>
</body>
</html>

